---
title: "BiB Data Dictionary"
output:
  pdf_document:
    includes:
      in_header: data_dict_style.sty
    toc: yes
  html_document: default
---

```{r setup, include = FALSE}
library(knitr)
library(dplyr)
library(pander)


source("C:/repos/bibloadr/R/bib_data_request_functions.R")

varfile <- "C:/repos/bibloadr/examples/variables.txt"

dat <- get_bibloadr_data(varfile = varfile, level = "child", label = TRUE, allow_hidden = TRUE)
meta <- get_bibloadr_meta(varfile = varfile, type = "varsection")
sourcemeta <- get_bibloadr_meta(varfile = varfile, type = "sourcelong")
codebook <- get_bibloadr_meta(varfile = varfile, type = "code")
```

```{r dictionary, echo = FALSE}

coding <- function(v) {
  
  c <- filter(codebook, VariableName == v & !is.na(CodeSetName))
  
  codeblock <- ""
  
  if(nrow(c) > 0) {
    
    codeblock <- paste0(c$Value, " = ", c$ValueLabel, "\\\n")
    codeblock <- c("\\\nCoding:\\\n", codeblock, "", "Coding ID: {{c$CodeSetName[1]}}")
  
  }
  
  return(knit_expand(text = codeblock))
  
}

vardescription <- function(var) {
  
  var_block <- ifelse(is.na(var$Description), "", "{{var$Description}}\\\n")
  var_block <- c("{{var$MeasureType}}, {{var$ValueType}} value\\\n",
                 "![Date value](Calendar-35.png)",
                 #only works in html: "<img src='Calendar-512.png' alt='Date value' style='width: 35px;'/>\\\n",
                 coding(v = var$VariableName), "\\\n")
  
  return(knit_expand(text = var_block))

}

source <- function(src) {

  src_block <- "
  
# {{src$SourceLongName}}

### Measurement level: {{src$MeasurementLevel}}

Source ID: {{src$SourceName}}

{{src$Description}}

"
  
  return(knit_expand(text = src_block))
  
}




out <- character(0)

for(s in 1:nrow(sourcemeta)) {
  
  out <- c(out, source(src = sourcemeta[s, ]))
  
  meta_bysource <- filter(meta, SourceName == sourcemeta$SourceName[s])
  
  meta_bysource$SectionName <- ifelse(is.na(meta_bysource$SectionName), "<GENERAL SECTION>", meta_bysource$SectionName)
  
  sections <- unique(meta_bysource$SectionName)
  
  for(se in 1:length(sections)) {

    meta_bysection <- filter(meta_bysource, SectionName == sections[se])
    
    section_table <- select(meta_bysection, Variable = VariableName, `Variable Label` = VariableLabel)
    
    if(sections[se] != "<GENERAL SECTION>") {
      
      out <- c(out, knit_expand(text = "## {{sections[se]}}"))
    
    }
    
    for(v in 1:nrow(meta_bysection)) {
      
      section_table$Details[v] <- vardescription(var = meta_bysection[v, ])

    }
    
    panderOptions("keep.line.breaks", TRUE)
    panderOptions("table.alignment.default", "left")
    panderOptions("table.alignment.rownames", "left")
    panderOptions("table.split.table", Inf)
    panderOptions("table.split.cells", c(30, 20, 85))
    
    out <- c(out, pander(section_table))
    
    } 
  
}


```

`r knit(text = out)`
